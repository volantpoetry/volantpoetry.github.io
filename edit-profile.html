<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Edit Profile | Volant Poetry</title>
  <link rel="stylesheet" href="style.css">
  <style>
    body { font-family: sans-serif; background:#f5f5f5; padding:20px; }
    .profile-form { max-width:400px; margin:auto; background:#fff; padding:20px; border-radius:8px; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
    .profile-form label { display:block; margin-top:10px; font-weight:600; }
    .profile-form input, .profile-form textarea { width:100%; padding:6px; margin-top:4px; border-radius:4px; border:1px solid #ccc; }
    .profile-form button { margin-top:15px; padding:8px 12px; border:none; background:#5a3cb3; color:white; border-radius:6px; cursor:pointer; }
    .profile-form button:disabled { opacity:0.6; cursor:not-allowed; }
    .success-msg { color:green; margin-top:10px; }
    .error-msg { color:red; margin-top:10px; }
  </style>
</head>
<body>

  <h2 style="text-align:center;">Edit Your Profile</h2>

  <div class="profile-form">
    <label>Username:</label>
    <input type="text" id="editUsername" placeholder="Enter your username">

    <label>Email:</label>
    <input type="email" id="editEmail" placeholder="Enter your email">

    <label>Bio:</label>
    <textarea id="editBio" rows="4" placeholder="Write something about yourself"></textarea>

    <button id="saveProfileBtn">Save Changes</button>

    <p class="success-msg" id="successMsg" style="display:none;">Profile updated successfully!</p>
    <p class="error-msg" id="errorMsg" style="display:none;">Failed to update profile. Try again.</p>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getFirestore, doc, getDoc, updateDoc, setDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
      apiKey: "AIzaSyC4DHI8aBVY4JjTvJ-r-TGIDPsewtEWxzU",
      authDomain: "silent-depth.firebaseapp.com",
      projectId: "silent-depth",
      storageBucket: "silent-depth.appspot.com",
      messagingSenderId: "78008755450",
      appId: "1:78008755450:web:3fd0f0f298a08820935543"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    const usernameInput = document.getElementById("editUsername");
    const emailInput = document.getElementById("editEmail");
    const bioInput = document.getElementById("editBio");
    const saveBtn = document.getElementById("saveProfileBtn");
    const successMsg = document.getElementById("successMsg");
    const errorMsg = document.getElementById("errorMsg");

    let currentUserUid = null;

    onAuthStateChanged(auth, async (user) => {
      if (!user) {
        alert("You must be logged in to edit your profile.");
        window.location.href = "users-login.html";
        return;
      }

      currentUserUid = user.uid;

      const userRef = doc(db, "users", user.uid);
      const userDoc = await getDoc(userRef);

      if (userDoc.exists()) {
        const data = userDoc.data();
        usernameInput.value = data.username || "";
        emailInput.value = data.email || "";
        bioInput.value = data.bio || "";
      } else {
        // Create a new document if missing
        await setDoc(userRef, { username: user.displayName || "", email: user.email, bio: "" });
        usernameInput.value = user.displayName || "";
        emailInput.value = user.email || "";
        bioInput.value = "";
      }
    });

    saveBtn.addEventListener("click", async () => {
      if (!currentUserUid) return;

      const newUsername = usernameInput.value.trim();
      const newEmail = emailInput.value.trim();
      const newBio = bioInput.value.trim();

      if (!newUsername || !newEmail) {
        errorMsg.textContent = "Username and Email are required!";
        errorMsg.style.display = "block";
        successMsg.style.display = "none";
        return;
      }

      saveBtn.disabled = true;
      errorMsg.style.display = "none";
      successMsg.style.display = "none";

      try {
        const userRef = doc(db, "users", currentUserUid);
        await updateDoc(userRef, {
          username: newUsername,
          email: newEmail,
          bio: newBio
        });

        successMsg.style.display = "block";
      } catch (err) {
        console.error("Error updating profile:", err);
        errorMsg.style.display = "block";
      } finally {
        saveBtn.disabled = false;
      }
    });
  </script>

</body>
</html>
