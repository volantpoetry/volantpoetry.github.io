<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Test Poem | Volant Poetry</title>
<link rel="stylesheet" href="tes.css">
<link rel="icon" type="image/png" href="images/logo.png">
<style>/* --- Poem Section Styling --- */
body {
  margin: 0;
  font-family: 'Inter', sans-serif;
  background: linear-gradient(135deg, #fdf6f0, #e2e9f0, #f7f0e5, #e8e0d8);
  background-size: 400% 400%;
  animation: gradientShift 15s ease infinite;
  color: #4b3f2f; /* classic text color */
}

/* Optional smooth animated gradient for subtle movement */
@keyframes gradientShift {
  0% { background-position: 0% 50%; }
  50% { background-position: 100% 50%; }
  100% { background-position: 0% 50%; }
}

/* Keep the poem-section transparent so the gradient shows through */
.poem-section {
  width: 100%;
  display: flex;
  justify-content: center;
  padding: 40px 20px;
  background-color: transparent; /* lets gradient show behind poem cards */
}



/* Poem Card - Classic Gradient Style */
.poem-card,
.recent-poem-card {
  background: linear-gradient(160deg, #fdf6f0, #e2e9f0); /* classic gradient */
  color: #4b3f2f; /* classic text color */
  border-radius: var(--radius, 14px);
  max-width: 700px;
  width: 100%;
  padding: 30px 25px;
  box-shadow: 0 8px 20px rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  gap: 15px;
  transition: transform 0.2s ease, box-shadow 0.2s ease;
}

.poem-card:hover,
.recent-poem-card:hover {
  transform: translateY(-5px);
  box-shadow: 0 12px 25px rgba(0,0,0,0.12);
}

/* Title and Content */
#poem-title {
  font-family: 'Playfair Display', serif;
  font-size: 1.8rem;
  color: #4b3f2f; /* matches classic theme */
  margin: 0;
}

#poem-content {
  font-family: 'Inter', sans-serif;
  font-size: 1rem;
  color: #4b3f2f; /* classic text */
  line-height: 1.6;
}

/* Author */
.author {
  font-style: italic;
  font-size: 0.9rem;
  color: #6b5a4c; /* slightly muted for classic feel */
}

/* Actions Horizontal */
.poem-actions-horizontal button {
  background-color: #4b3f2f; /* classic dark accent */
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.9rem;
  transition: background-color 0.2s ease;
}

.poem-actions-horizontal button:hover {
  background-color: #3a3227; /* darker hover */
}

/* Comment Section */
.comment-section-inline input {
  padding: 6px 10px;
  border-radius: 8px;
  border: 1px solid #ccc;
  font-size: 0.9rem;
  flex: 1;
}

.comment-section-inline button {
  background-color: #4b3f2f;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.9rem;
}

.comment-section-inline button:hover {
  background-color: #3a3227;
}

/* Comment List */
.comment-list {
  max-height: 200px;
  overflow-y: auto;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

/* Scrollbar Styling for Comments */
.comment-list::-webkit-scrollbar {
  width: 6px;
}
.comment-list::-webkit-scrollbar-thumb {
  background-color: #4b3f2f;
  border-radius: 3px;
}


/* Like button highlight */
.like-btn {
  background-color: #4b3f2f;
  color: #fff;
  border: none;
  border-radius: 8px;
  padding: 6px 12px;
  cursor: pointer;
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 5px;
  transition: background-color 0.2s ease, transform 0.2s ease;
}

.like-btn.liked {
  background-color: #e63946; /* red highlight when liked */
  transform: scale(1.1); /* slight pop */
}

.like-btn span {
  font-weight: bold;
}

/* Responsive */
@media (max-width: 768px) {
  .poem-card,
  .recent-poem-card {
    padding: 20px 15px;
    width: 84%;
    max-width: 100%;
    margin-left: -8%; /* shifts the card slightly to the left */
  }

  #poem-title {
    font-size: 1.5rem;
  }
}
</style>
</head>
<body>

 
<section class="poem-section">
  <div id="poem-container" class="poem-card">
    <h2 id="poem-title"></h2>
    <p id="poem-content"></p>
    <span class="author" id="poem-author"></span>

    <div class="poem-actions-horizontal" style="display:flex; gap:10px; margin-top:10px;">
      <button class="like-btn" id="like-btn">‚ù§Ô∏è <span id="like-count">0</span></button>
      <button class="message-count" id="message-count">üí¨ 0</button>
      <div class="comment-section-inline" style="display:flex; gap:5px; align-items:center;">
        <input type="text" id="comment-input" placeholder="Write a comment..." />
        <button class="comment-btn" id="comment-btn">Post</button>
      </div>
    </div>

    <div class="comment-list" id="comment-list" style="margin-top:10px;"></div>
  </div>
</section>

<script type="module">import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, query, where, getDocs, doc, getDoc, updateDoc, arrayUnion, increment, enableIndexedDbPersistence, orderBy } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4DHI8aBVY4JjTvJ-r-TGIDPsewtEWxzU",
  authDomain: "silent-depth.firebaseapp.com",
  projectId: "silent-depth",
  storageBucket: "silent-depth.appspot.com",
  messagingSenderId: "78008755450",
  appId: "1:78008755450:web:3fd0f0f298a08820935543"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);
const auth = getAuth(app);
enableIndexedDbPersistence(db).catch(err => console.warn("Persistence error:", err.code));

const params = new URLSearchParams(window.location.search);
const slug = params.get("slug");

const titleEl = document.getElementById("poem-title");
const contentEl = document.getElementById("poem-content");
const authorEl = document.getElementById("poem-author");
const likeBtn = document.getElementById("like-btn");
const likeCountEl = document.getElementById("like-count");
const commentInput = document.getElementById("comment-input");
const commentBtn = document.getElementById("comment-btn");
const commentList = document.getElementById("comment-list");
const messageCountEl = document.getElementById("message-count");

let currentUser = null;
let poemDocRef = null;

onAuthStateChanged(auth, user => {
  currentUser = user;
  if(slug) loadPoem(slug);
});

async function loadPoem(slug) {
  const collectionsToCheck = ["recentPoems", "classicPoems"]; // Check both
  let found = false;

  for (const colName of collectionsToCheck) {
    const colRef = collection(db, colName);
    const snapshot = await getDocs(colRef);

    if(snapshot.empty) continue;

    const docSnap = snapshot.docs.find(docSnap => {
      const data = docSnap.data();
      const docSlug = data.slug || (data.title ? data.title.toLowerCase().replace(/\s+/g, "-") : docSnap.id);
      return docSlug === slug;
    });

    if(docSnap) {
      poemDocRef = doc(db, colName, docSnap.id);
      const data = docSnap.data();

      titleEl.textContent = data.title || "Untitled";
      contentEl.innerHTML = data.content ? data.content.replace(/\n/g,"<br>") : "";
      authorEl.textContent = data.authorName || data.author || data.username || "Anonymous";
      likeCountEl.textContent = typeof data.likes==="number" ? data.likes : 0;

      // Show/hide actions depending on collection
      const actionsEl = document.querySelector(".poem-actions-horizontal");
      if(colName === "classicPoems"){
        actionsEl.style.display = "none"; // Hide actions for featured poems
      } else {
        actionsEl.style.display = "flex"; // Show actions for recent poems
      }

      if(currentUser && Array.isArray(data.likedBy) && data.likedBy.includes(currentUser.uid)){
        likeBtn.classList.add("liked");
      } else {
        likeBtn.classList.remove("liked");
      }

      // Load comments only if recent poem
      if(colName === "recentPoems") loadCommentsCount(colName, docSnap.id);

      found = true;
      break;
    }
  }

  if(!found) {
    titleEl.textContent = "Poem not found";
    contentEl.innerHTML = "";
    authorEl.textContent = "";
    document.querySelector(".poem-actions-horizontal").style.display = "none"; // hide actions if no poem
  }
}

// ---------------- Like ----------------
likeBtn.addEventListener("click", async () => {
  if(!currentUser){ alert("Sign in to like!"); return; }
  if(!poemDocRef) return;

  const docSnap = await getDoc(poemDocRef);
  const data = docSnap.data();
  let likes = typeof data.likes==="number"?data.likes:0;
  const likedBy = Array.isArray(data.likedBy)?data.likedBy:[];

  if(likedBy.includes(currentUser.uid)){
    await updateDoc(poemDocRef, { likes: increment(-1), likedBy: likedBy.filter(uid=>uid!==currentUser.uid) });
    likeCountEl.textContent = likes-1;
    likeBtn.classList.remove("liked");
  } else {
    await updateDoc(poemDocRef, { likes: increment(1), likedBy: arrayUnion(currentUser.uid) });
    likeCountEl.textContent = likes+1;
    likeBtn.classList.add("liked");
  }
});

// ---------------- Comment Post ----------------
commentBtn.addEventListener("click", async () => {
  if(!currentUser){ alert("Sign in to comment!"); return; }
  if(!poemDocRef) return;

  const text = commentInput.value.trim();
  if(!text) return;

  await addDoc(collection(db, poemDocRef.parent.id, poemDocRef.id, "comments"), {
    userId: currentUser.uid,
    text,
    timestamp: new Date()
  });

  commentInput.value = "";
  loadComments();
});

// ---------------- Load Comments ----------------
async function loadComments() {
  if(!poemDocRef) return;

  const q = query(collection(db, poemDocRef.parent.id, poemDocRef.id, "comments"), orderBy("timestamp","desc"));
  const snapshot = await getDocs(q);
  messageCountEl.textContent = `üí¨ ${snapshot.size}`;
  
  commentList.innerHTML = "";
  snapshot.forEach(docSnap => {
    const data = docSnap.data();
    const div = document.createElement("div");
    div.style.padding = "6px 0";
    div.style.borderBottom = "1px solid #eee";
    div.innerHTML = `<strong>${data.userId}</strong>: ${data.text}`;
    commentList.appendChild(div);
  });
  commentList.style.display = snapshot.size ? "block" : "none";
}


// ---------------- Navbar toggle ----------------
const toggle = document.getElementById("menu-toggle");
const navLinks = document.getElementById("nav-links");
toggle.addEventListener("click", ()=>navLinks.classList.toggle("show"));
navLinks.querySelectorAll("a").forEach(link => link.addEventListener("click", ()=>navLinks.classList.remove("show")));
</script>
</body>
</html>
