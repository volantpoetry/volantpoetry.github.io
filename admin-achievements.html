<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Achievements Admin</title>
<style>
  body { font-family: Arial, sans-serif; padding: 20px; background: #f7f7f7; }
  h1 { text-align: center; }
  form { background: #fff; padding: 20px; border-radius: 8px; margin-bottom: 20px; max-width: 500px; margin: 0 auto 20px; box-shadow: 0 2px 6px rgba(0,0,0,0.1);}
  label { display:block; margin-top: 10px; font-weight: 600; }
  input, select, textarea { width: 100%; padding: 8px; margin-top: 4px; border-radius: 6px; border: 1px solid #ccc; }
  button { margin-top: 12px; padding: 10px 16px; border:none; border-radius:6px; background:#5a3cb3; color:white; cursor:pointer; }
  .achievement { background: #fff; padding: 12px 16px; border-radius: 8px; margin-bottom: 12px; display:flex; align-items:center; box-shadow:0 1px 4px rgba(0,0,0,0.1); }
  .achievement img { width: 50px; height: 50px; border-radius: 50%; margin-right: 12px; object-fit:cover; }
  .achievement-details { flex:1; }
  .achievement-actions button { margin-left: 6px; background:#888; }
  .checkbox-container { margin-right: 12px; }
</style>
</head>
<body>

<h1>Achievements Admin</h1>

<form id="achievementForm">
  <input type="hidden" id="achId">
  <label for="title">Title</label>
  <input type="text" id="title" required>

  <label for="description">Description</label>
  <textarea id="description" rows="2"></textarea>

  <label for="conditionType">Condition Type</label>
  <select id="conditionType">
    <option value="poemsSubmitted">Poems Submitted</option>
    <option value="likesReceived">Likes Received</option>
    <option value="commentsMade">Comments Made</option>
    <option value="commentsReceived">Comments Received</option>
  </select>

  <label for="conditionMin">Minimum Value</label>
  <input type="number" id="conditionMin" min="1" required>

  <label for="active">Active</label>
  <input type="checkbox" id="active" checked>

  <label for="badgeImage">Badge Image</label>
  <input type="file" id="badgeImage" accept="image/*">

  <button type="submit">Save Achievement</button>
</form>

<!-- Delete Selected Button -->
<button id="deleteSelected" style="background:#e74c3c;">Delete Selected</button>

<div id="achievementsList"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
import { getFirestore, collection, addDoc, getDocs, doc, updateDoc, deleteDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyC4DHI8aBVY4JjTvJ-r-TGIDPsewtEWxzU",
  authDomain: "silent-depth.firebaseapp.com",
  projectId: "silent-depth",
  storageBucket: "silent-depth.appspot.com",
  messagingSenderId: "78008755450",
  appId: "1:78008755450:web:3fd0f0f298a08820935543"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

let selectedImageFile = null;
document.getElementById("badgeImage").addEventListener("change", (e) => {
  selectedImageFile = e.target.files[0] || null;
});

// Upload image
async function uploadToCloudinary(file) {
  if (!file) return "";
  const cloudName = "dzoq4pgjn";
  const uploadPreset = "achievements";
  const formData = new FormData();
  formData.append("file", file);
  formData.append("upload_preset", uploadPreset);

  try {
    const res = await fetch(`https://api.cloudinary.com/v1_1/${cloudName}/image/upload`, {
      method: "POST",
      body: formData
    });
    const data = await res.json();
    return data.secure_url;
  } catch (err) {
    console.error("Cloudinary upload failed:", err);
    alert("Image upload failed.");
    return "";
  }
}

// Form submission
const form = document.getElementById("achievementForm");
form.addEventListener("submit", async (e) => {
  e.preventDefault();
  const title = document.getElementById("title").value.trim();
  const description = document.getElementById("description").value.trim();
  const type = document.getElementById("conditionType").value;
  const min = parseInt(document.getElementById("conditionMin").value);
  const active = document.getElementById("active").checked;
  const achId = document.getElementById("achId").value;

  let imageUrl = "";
  if (selectedImageFile) imageUrl = await uploadToCloudinary(selectedImageFile);

  try {
    if (achId) {
      const achRef = doc(db, "achievements", achId);
      const updateData = { title, description, condition: { type, min }, active };
      if (imageUrl) updateData.imageUrl = imageUrl;
      await updateDoc(achRef, updateData);
    } else {
      await addDoc(collection(db, "achievements"), {
        title, description, condition: { type, min }, imageUrl, active
      });
    }
    form.reset();
    document.getElementById("achId").value = "";
    selectedImageFile = null;
    loadAchievements();
  } catch (err) {
    console.error(err);
    alert("Failed to save achievement.");
  }
});

// Load achievements
async function loadAchievements() {
  const list = document.getElementById("achievementsList");
  list.innerHTML = "";
  const snapshot = await getDocs(collection(db, "achievements"));
  const achievements = snapshot.docs.map(docSnap => ({ id: docSnap.id, ...docSnap.data() }));
  achievements.sort((a, b) => a.title.localeCompare(b.title));

  achievements.forEach(data => {
    const div = document.createElement("div");
    div.className = "achievement";
    div.innerHTML = `
      <input type="checkbox" class="select-achievement checkbox-container" data-id="${data.id}">
      <img src="${data.imageUrl || 'https://via.placeholder.com/50'}" alt="badge">
      <div class="achievement-details">
        <strong>${data.title}</strong> - ${data.description} <br>
        Condition: ${data.condition.type} â‰¥ ${data.condition.min} <br>
        Active: ${data.active ? "Yes" : "No"}
      </div>
      <div class="achievement-actions">
        <button onclick="editAchievement('${data.id}')">Edit</button>
        <button onclick="deleteAchievement('${data.id}')">Delete</button>
      </div>
    `;
    list.appendChild(div);
  });
}

// Edit achievement
window.editAchievement = async (id) => {
  const achRef = doc(db, "achievements", id);
  const docSnap = await getDoc(achRef);
  if (!docSnap.exists()) return;
  const data = docSnap.data();
  document.getElementById("title").value = data.title || "";
  document.getElementById("description").value = data.description || "";
  document.getElementById("conditionType").value = data.condition.type || "poemsSubmitted";
  document.getElementById("conditionMin").value = data.condition.min || 1;
  document.getElementById("active").checked = data.active || false;
  document.getElementById("achId").value = id;
  selectedImageFile = null;
}

// Delete single achievement
window.deleteAchievement = async (id) => {
  if (!confirm("Are you sure you want to delete this achievement?")) return;
  await deleteDoc(doc(db, "achievements", id));
  loadAchievements();
}

// Delete selected achievements
document.getElementById("deleteSelected").addEventListener("click", async () => {
  const checkboxes = document.querySelectorAll(".select-achievement:checked");
  if (checkboxes.length === 0) return alert("Select at least one achievement to delete.");
  if (!confirm(`Are you sure you want to delete ${checkboxes.length} selected achievement(s)?`)) return;

  for (const cb of checkboxes) {
    const id = cb.dataset.id;
    await deleteDoc(doc(db, "achievements", id));
  }
  loadAchievements();
});

// Initial load
loadAchievements();
</script>

</body>
</html>
